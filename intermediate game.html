<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTIPLAYER BATTLE (WITH COUNTDOWN)</title>
    <style>
        /* CSS VARIABLES & RESET */
        :root { --bg: #0f172a; --card: #1e293b; --sidebar: #111827; --primary: #38bdf8; --text: #f8fafc; --muted: #94a3b8; --danger: #f87171; --success: #4ade80; --warning: #fbbf24; --p1: #3b82f6; --p2: #ef4444; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; transition: background-color 0.3s; }
        
        /* INTRO SCREEN & LOBBY */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; transition: opacity 0.5s ease-out; }
        .intro-content { z-index: 10; text-align: center; position: relative; width: 100%; max-width: 800px; padding: 20px; }
        .intro-title { font-size: 3rem; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; font-weight: 800; letter-spacing: 2px; }
        
        .lobby-box { background: rgba(30, 41, 59, 0.95); padding: 30px; border-radius: 20px; border: 1px solid var(--primary); display: flex; flex-direction: column; gap: 15px; width: 350px; margin: 0 auto; box-shadow: 0 0 30px rgba(56, 189, 248, 0.2); }
        .room-input { padding: 15px; border-radius: 10px; border: 2px solid #475569; background: #0f172a; color: white; font-size: 1.2rem; text-align: center; letter-spacing: 3px; text-transform: uppercase; font-weight: bold; width: 100%; }
        .lobby-btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; width: 100%; }
        .btn-create { background: var(--primary); color: #0f172a; margin-bottom: 10px; }
        .btn-join { background: var(--success); color: #0f172a; }
        .btn-create:hover, .btn-join:hover { transform: scale(1.02); filter: brightness(1.1); }
        .lobby-status { margin-top: 10px; color: var(--warning); font-size: 0.9rem; min-height: 20px; text-align: center; }

        /* MAIN APP LAYOUT */
        #main-app { display: none; width: 100%; height: 100vh; flex-direction: row; }
        .sidebar { width: 250px; background: var(--sidebar); border-right: 1px solid #334155; display: flex; flex-direction: column; padding: 20px 10px; gap: 5px; flex-shrink: 0; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; background: var(--bg); }
        .content-container { background: var(--card); padding: 2rem; border-radius: 20px; width: 100%; max-width: 900px; border: 1px solid #334155; position: relative; }

        /* SETTINGS BAR */
        .settings-bar { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #334155; }
        .score-input { width: 60px; padding: 5px; text-align: center; border-radius: 5px; border: none; font-weight: bold; font-size: 1rem; }
        .apply-btn { background: var(--warning); border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }

        /* GAME ZONES */
        .battle-arena { display: flex; gap: 10px; margin-top: 20px; }
        .player-zone { flex: 1; height: 200px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 3px solid #333; background: rgba(0,0,0,0.2); transition: 0.2s; position: relative; }
        .p1-zone { border-color: var(--p1); } .p2-zone { border-color: var(--p2); }
        .p-score { font-size: 3rem; font-weight: 800; }
        .battle-center { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .b-word { font-size: 2rem; font-weight: bold; }
        .b-def { font-size: 1.2rem; color: var(--primary); margin: 10px 0; min-height: 40px; }
        .msg-box { font-size: 1.5rem; font-weight: 800; height: 40px; margin-top: 10px; transition: transform 0.2s; }
        
        /* COUNTDOWN ANIMATION */
        .countdown-pulse { animation: pulse 0.5s ease-in-out; color: var(--warning); font-size: 2.5rem; }
        @keyframes pulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }

        /* WINNER OVERLAY */
        #winner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.5s; }
        .winner-title { font-size: 4rem; color: var(--warning); text-shadow: 0 0 20px rgba(251, 191, 36, 0.5); font-weight: 800; margin-bottom: 20px; }
        .winner-subtitle { font-size: 1.5rem; color: white; margin-bottom: 30px; }
        .reset-btn { padding: 15px 40px; font-size: 1.5rem; background: var(--success); border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); transition: 0.2s; }
        .reset-btn:hover { transform: scale(1.1); }
        
        /* CONTROLS */
        .tab-btn { background: transparent; color: var(--text); border: none; padding: 12px 15px; cursor: pointer; border-radius: 8px; font-size: 0.95rem; text-align: left; display: flex; align-items: center; gap: 10px; width: 100%; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: var(--primary); color: #0f172a; font-weight: bold; }
        .role-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .role-p1 { background: var(--p1); color: white; } .role-p2 { background: var(--p2); color: white; }
        
        @media (max-width: 768px) {
            #main-app { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; }
            .battle-arena { flex-direction: column; }
        }
    </style>
</head>
<body>

<audio id="bg-music" loop><source src="backsound.mp3" type="audio/mpeg"></audio>
<audio id="sfx-beep" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
<audio id="sfx-go" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg"></audio>

<div id="winner-overlay">
    <div class="winner-title" id="winner-text">PLAYER 1 WINS!</div>
    <div class="winner-subtitle">Congratulations!</div>
    <button class="reset-btn" id="reset-btn" onclick="window.resetGame()">PLAY AGAIN üîÑ</button>
    <div id="waiting-reset-msg" style="margin-top:20px; color:#aaa; display:none;">Waiting for Host to reset...</div>
</div>

<div id="intro-screen">
    <div class="intro-content">
        <div class="intro-title">ENGLISH BATTLE</div>
        <div class="lobby-box">
            <h3 style="margin:0; text-align:center; color:white;">MULTIPLAYER LOBBY</h3>
            <input type="text" id="room-code" class="room-input" placeholder="CODE" maxlength="4">
            <button class="lobby-btn btn-create" id="btn-create" onclick="window.createRoom()">CREATE NEW ROOM (HOST)</button>
            <button class="lobby-btn btn-join" id="btn-join" onclick="window.joinRoom()">JOIN ROOM (PLAYER)</button>
            <div id="lobby-status" class="lobby-status">Ready to connect...</div>
        </div>
    </div>
</div>

<div id="main-app">
    <nav class="sidebar">
        <div style="color:var(--primary); font-weight:bold; padding:10px;">MENU</div>
        <div style="padding:0 10px 20px 10px; font-size:0.9rem;">Role: <span id="my-role-badge">---</span></div>
        <button class="tab-btn active">‚öîÔ∏è Battle Mode</button>
        <button class="tab-btn" onclick="location.reload()" style="margin-top:auto; color:var(--danger);">‚¨Ö Exit Room</button>
    </nav>

    <main class="main-content">
        <div class="content-container">
            <div class="settings-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>Room: <strong id="display-room-code" style="color:var(--primary);">---</strong></span>
                </div>
                
                <div id="host-controls" style="display:none;">
                    <label>Target Points:</label>
                    <input type="number" id="target-score-input" class="score-input" value="10" min="1" max="50">
                    <button class="apply-btn" onclick="window.updateRules()">SET</button>
                    <button class="apply-btn" id="btn-start-trigger" onclick="window.triggerCountdown()" style="background:var(--success);">START ROUND</button>
                </div>

                <div id="player-view" style="display:none; font-weight:bold;">
                    Target to Win: <span id="display-target" style="color:var(--warning); font-size:1.2rem;">10</span>
                </div>
            </div>

            <div id="tab-battle" style="display:block;">
                <div class="battle-arena">
                    <div class="player-zone p1-zone" id="zone-p1">
                        <div>PLAYER 1</div>
                        <div class="p-score" id="score-p1">0</div>
                        <div style="font-size:0.8rem; opacity:0.7;">Key: A (True) / S (False)</div>
                    </div>
                    <div class="player-zone p2-zone" id="zone-p2">
                        <div>PLAYER 2</div>
                        <div class="p-score" id="score-p2">0</div>
                        <div style="font-size:0.8rem; opacity:0.7;">Key: K (True) / L (False)</div>
                    </div>
                </div>
                <div class="battle-center">
                    <div class="b-word" id="game-word">WAITING...</div>
                    <div style="font-style:italic; color:#666;">means</div>
                    <div class="b-def" id="game-def">Waiting for Host to Start</div>
                    <div class="msg-box" id="game-msg"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="intermediate game.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // 1. CONFIGURATION
   const firebaseConfig = {
  apiKey: "AIzaSyAgYCaaoGMzZWVT2dRov7ALUnnMhHoqXmE",
  authDomain: "english-check-db.firebaseapp.com",
  databaseURL: "https://english-check-db-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "english-check-db",
  storageBucket: "english-check-db.firebasestorage.app",
  messagingSenderId: "136352630898",
  appId: "1:136352630898:web:dcaa103fa848ca38de9aeb"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 3. VOCABULARY LIST


    // 4. GLOBAL VARIABLES
    let myRole = 0; // 1 = Host, 2 = Joiner
    let currentRoom = "";
    let lastKeyTimestamp = 0;
    let targetScore = 10;
    let gameActive = false; // Initially false until countdown finishes

    // --- CREATE ROOM ---
    window.createRoom = function() {
        const btn = document.getElementById('btn-create');
        const status = document.getElementById('lobby-status');
        btn.disabled = true; btn.innerText = "Creating..."; status.innerText = "Connecting...";

        const code = Math.floor(1000 + Math.random() * 9000).toString();
        
        set(ref(db, 'matches/' + code), {
            status: 'waiting',
            target: 10,
            winner: null,
            scores: { p1: 0, p2: 0 },
            round: { word: "Ready", def: "Press Start", answer: null, timestamp: 0 },
            input: { player: 0, key: '', timestamp: 0 },
            msg: ""
        }).then(() => { enterGame(code, 1); })
          .catch((e) => { alert(e.message); btn.disabled = false; });
    };

    // --- JOIN ROOM ---
    window.joinRoom = function() {
        const code = document.getElementById('room-code').value.trim();
        const btn = document.getElementById('btn-join');
        if (code.length !== 4) { alert("Invalid Code"); return; }

        btn.disabled = true; btn.innerText = "Joining...";
        
        const roomRef = ref(db, 'matches/' + code);
        get(roomRef).then((snap) => {
            if (snap.exists()) {
                update(roomRef, { status: 'connected' });
                enterGame(code, 2);
            } else {
                alert("Room not found!");
                btn.disabled = false; btn.innerText = "JOIN ROOM";
            }
        });
    };

    // --- GAME UI INIT ---
    function enterGame(code, role) {
        currentRoom = code;
        myRole = role;

        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('display-room-code').innerText = code;
        
        const badge = document.getElementById('my-role-badge');
        badge.innerText = role === 1 ? "PLAYER 1 (HOST)" : "PLAYER 2";
        badge.className = role === 1 ? "role-badge role-p1" : "role-badge role-p2";

        if (role === 1) {
            document.getElementById('host-controls').style.display = 'block';
            document.getElementById('reset-btn').style.display = 'block';
            document.getElementById('waiting-reset-msg').style.display = 'none';
        } else {
            document.getElementById('player-view').style.display = 'block';
            document.getElementById('reset-btn').style.display = 'none';
            document.getElementById('waiting-reset-msg').style.display = 'block';
        }

        listenToRoom();
    }

    // --- RULES UPDATE ---
    window.updateRules = function() {
        if(myRole !== 1) return;
        const val = document.getElementById('target-score-input').value;
        const newTarget = parseInt(val);
        if(newTarget > 0) {
            update(ref(db, 'matches/' + currentRoom), { target: newTarget });
            alert("Winning score set to " + newTarget);
        }
    };

    // --- COUNTDOWN LOGIC (HOST) ---
    // This replaces immediate start
    window.triggerCountdown = function() {
        if(myRole !== 1) return;
        
        // Disable Start Button temporarily
        const btn = document.getElementById('btn-start-trigger');
        btn.disabled = true;

        let count = 3;

        // Function to update msg recursively
        const runTimer = () => {
            if (count > 0) {
                update(ref(db, 'matches/' + currentRoom), { msg: count.toString() });
                count--;
                setTimeout(runTimer, 1000);
            } else {
                // Countdown finished
                update(ref(db, 'matches/' + currentRoom), { msg: "GO!" });
                setTimeout(() => {
                    broadcastStart();
                    btn.disabled = false;
                }, 500);
            }
        };
        
        runTimer();
    };

    // --- BROADCAST ROUND (Called after Countdown) ---
    function broadcastStart() {
        const item = fullVocab[Math.floor(Math.random() * fullVocab.length)];
        const isTrue = Math.random() < 0.5;
        let showDef = item.idn;
        
        if (!isTrue) {
            let wrong = fullVocab[Math.floor(Math.random() * fullVocab.length)];
            while(wrong.eng === item.eng) wrong = fullVocab[Math.floor(Math.random() * fullVocab.length)];
            showDef = wrong.idn;
        }

        // Set game active on Host immediately, but Firebase listener will sync it too
        // Important: msg is cleared so "GO!" disappears after a moment
        update(ref(db, 'matches/' + currentRoom + '/round'), {
            word: item.eng, def: showDef, answer: isTrue, timestamp: Date.now()
        });
        
        // Slightly delay clearing the GO message so user sees it, then sees the question
        setTimeout(() => {
             update(ref(db, 'matches/' + currentRoom), { msg: "" });
        }, 1000);
    }

    // --- RESET GAME ---
    window.resetGame = function() {
        if(myRole !== 1) return;
        update(ref(db, 'matches/' + currentRoom), {
            scores: { p1: 0, p2: 0 },
            winner: null,
            msg: "Game Reset!",
            round: { word: "Ready", def: "Press Start", answer: null, timestamp: Date.now() }
        });
        document.getElementById('winner-overlay').style.display = 'none';
        gameActive = false;
    };

    // --- FIREBASE LISTENER ---
    function listenToRoom() {
        const roomRef = ref(db, 'matches/' + currentRoom);
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // Update UI Elements
            if (data.target) {
                targetScore = data.target;
                document.getElementById('display-target').innerText = targetScore;
                if(myRole === 1) document.getElementById('target-score-input').value = targetScore;
            }

            if (data.scores) {
                document.getElementById('score-p1').innerText = data.scores.p1;
                document.getElementById('score-p2').innerText = data.scores.p2;
            }

            if (data.round) {
                document.getElementById('game-word').innerText = data.round.word;
                document.getElementById('game-def').innerText = data.round.def;
            }

            // Message & Sound Handler
            if (data.msg !== undefined) {
                const msgBox = document.getElementById('game-msg');
                msgBox.innerText = data.msg;
                msgBox.className = "msg-box"; // reset class

                // Handle Countdown Sounds & Visuals
                if (["3", "2", "1"].includes(data.msg)) {
                    document.getElementById('sfx-beep').play().catch(()=>{});
                    msgBox.classList.add('countdown-pulse'); // Add animation
                    gameActive = false; // Lock input
                } 
                else if (data.msg === "GO!") {
                    document.getElementById('sfx-go').play().catch(()=>{});
                    msgBox.style.color = "var(--success)";
                    msgBox.classList.add('countdown-pulse');
                    gameActive = true; // Unlock input
                }
                else if (data.msg === "") {
                    // Normal state (Question displayed)
                    gameActive = true;
                }
                else {
                    // Result messages (Win/Wrong)
                    if(data.msg.includes("Wins")) msgBox.style.color = "var(--success)";
                    else msgBox.style.color = "var(--text)";
                    
                    // Brief pause after result before next input is valid
                    // (Actually handled by Host logic delay)
                }
            }

            // Check Winner
            if (data.winner) {
                gameActive = false;
                document.getElementById('winner-text').innerText = data.winner + " WINS!";
                document.getElementById('winner-overlay').style.display = 'flex';
            } else {
                document.getElementById('winner-overlay').style.display = 'none';
            }

            // Host Process Input
            if (myRole === 1 && gameActive && data.input && data.input.timestamp > lastKeyTimestamp) {
                lastKeyTimestamp = data.input.timestamp;
                processInput(data.input.player, data.input.key, data.round.answer, data.scores);
            }
        });
    }

    // --- HOST LOGIC: PROCESS INPUT ---
    function processInput(player, key, ans, scores) {
        if(!gameActive) return; // Ignore input if game paused/countdown
        
        let choice = null;
        if (player === 1) { if(key === 'a') choice=true; if(key === 's') choice=false; }
        if (player === 2) { if(key === 'k') choice=true; if(key === 'l') choice=false; }
        if (choice === null) return;

        let p1 = scores.p1; let p2 = scores.p2;
        let msg = "";

        if (choice === ans) {
            msg = `Player ${player} Correct!`;
            if(player===1) p1++; else p2++;
        } else {
            msg = `Player ${player} Wrong!`;
            if(player===1) p2++; else p1++;
        }

        // Check Win Condition
        let winner = null;
        if (p1 >= targetScore) winner = "PLAYER 1";
        if (p2 >= targetScore) winner = "PLAYER 2";

        // Stop accepting input immediately
        gameActive = false;

        update(ref(db, 'matches/' + currentRoom), {
            scores: { p1, p2 },
            msg: msg,
            winner: winner,
            input: { player:0, key:'', timestamp: Date.now() }
        });

        if(!winner) {
            // Auto restart countdown after 1.5s delay showing the result
            setTimeout(() => { window.triggerCountdown(); }, 1500);
        }
    }

    // --- KEYBOARD ---
    document.addEventListener('keydown', (e) => {
        if (!currentRoom || !gameActive) return; // Lock keys during countdown/pause
        const key = e.key.toLowerCase();
        if (myRole === 1 && (key === 'a' || key === 's')) sendKey(1, key);
        if (myRole === 2 && (key === 'k' || key === 'l')) sendKey(2, key);
    });

    function sendKey(role, key) {
        update(ref(db, 'matches/' + currentRoom + '/input'), {
            player: role, key: key, timestamp: Date.now()
        });
    }
</script>

</body>
</html>