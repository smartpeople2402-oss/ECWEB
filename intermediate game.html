<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTIPLAYER INTERMEDIATE (ONLINE)</title>
    <style>
        /* CSS VARIABLES */
        :root { --bg: #0f172a; --card: #1e293b; --sidebar: #111827; --primary: #38bdf8; --text: #f8fafc; --muted: #94a3b8; --danger: #f87171; --success: #4ade80; --warning: #fbbf24; --p1: #3b82f6; --p2: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; transition: background-color 0.3s; }
        
        /* INTRO SCREEN & LOBBY */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; transition: opacity 0.5s ease-out; }
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .intro-content { z-index: 10; text-align: center; position: relative; width: 100%; max-width: 800px; padding: 20px; }
        
        .intro-title { font-size: 3.5rem; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 20px rgba(56, 189, 248, 0.3); font-weight: 800; }
        .intro-subtitle { font-size: 1.2rem; color: var(--muted); margin-bottom: 30px; }
        
        /* LOBBY STYLES */
        .lobby-box { background: rgba(30, 41, 59, 0.9); padding: 30px; border-radius: 20px; border: 1px solid var(--primary); backdrop-filter: blur(10px); display: flex; flex-direction: column; gap: 15px; width: 350px; margin: 0 auto; box-shadow: 0 0 30px rgba(56, 189, 248, 0.2); }
        .room-input { padding: 15px; border-radius: 10px; border: 2px solid #475569; background: #0f172a; color: white; font-size: 1.1rem; text-align: center; letter-spacing: 2px; text-transform: uppercase; }
        .lobby-btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-create { background: var(--primary); color: #0f172a; }
        .btn-join { background: var(--success); color: #0f172a; }
        .btn-create:hover, .btn-join:hover { transform: scale(1.05); }
        .lobby-status { margin-top: 10px; color: var(--warning); font-size: 0.9rem; min-height: 20px; }

        /* MAIN APP */
        #main-app { display: none; width: 100%; height: 100vh; flex-direction: row; }
        
        .sidebar { width: 250px; background: var(--sidebar); border-right: 1px solid #334155; display: flex; flex-direction: column; padding: 20px 10px; gap: 5px; overflow-y: auto; flex-shrink: 0; }
        .sidebar-header { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; padding-left: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .user-welcome { font-size: 0.85rem; color: var(--success); padding-left: 10px; margin-bottom: 15px; font-weight: 500; }
        .nav-category { font-size: 0.8rem; color: var(--muted); text-transform: uppercase; margin: 15px 0 5px 10px; font-weight: bold; }
        .tab-btn { background: transparent; color: var(--text); border: none; padding: 12px 15px; cursor: pointer; border-radius: 8px; font-size: 0.95rem; text-align: left; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: var(--primary); color: #0f172a; font-weight: bold; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        
        .back-btn { background: rgba(248, 113, 113, 0.2); color: var(--danger); border: 1px solid var(--danger); margin-bottom: 20px; font-weight: bold; justify-content: center; }
        .back-btn:hover { background: var(--danger); color: white; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; background: var(--bg); }
        .content-container { background: var(--card); padding: 2.5rem; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 100%; max-width: 900px; border: 1px solid #334155; position: relative; transition: background-color 0.3s; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CONTROLS */
        .game-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 10px; flex-wrap: wrap; gap: 10px; }
        .left-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        
        .music-wrapper { display: flex; align-items: center; border-left: 1px solid #475569; padding-left: 15px; margin-left: 5px; }
        .music-btn { background: none; border: 1px solid #475569; color: var(--muted); cursor: pointer; font-size: 1.2rem; padding: 5px 10px; border-radius: 5px; transition: 0.3s; margin-right: 10px; }
        .music-btn.playing { color: var(--success); border-color: var(--success); box-shadow: 0 0 10px rgba(74, 222, 128, 0.2); }
        .music-btn:hover { background: rgba(255,255,255,0.1); }
        input[type=range] { width: 70px; height: 5px; background: #475569; border-radius: 5px; outline: none; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; border-radius: 50%; background: var(--primary); cursor: pointer; transition: 0.2s; }
        .theme-select { margin-left: 15px; padding: 5px; border-radius: 5px; background: var(--bg); color: var(--text); border: 1px solid #475569; }

        /* TAB UI */
        h1 { color: var(--primary); text-align: center; margin: 10px 0 20px 0; font-size: 2rem; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .settings-input { width: 70px; padding: 8px; border-radius: 8px; border: 2px solid #475569; background: var(--bg); color: var(--text); font-size: 1.1rem; text-align: center; }
        .btns { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        button.action-btn { background: var(--primary); color: var(--bg); border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; z-index: 20; position: relative; }
        button.action-btn:active { transform: scale(0.95); }
        
        /* BATTLE MODE STYLES */
        .battle-arena { display: flex; justify-content: space-between; flex: 1; align-items: center; gap: 10px; width: 100%; margin-top: 20px; }
        .player-zone { flex: 1; height: 280px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 3px solid; background: rgba(0,0,0,0.2); transition: 0.2s; }
        .p1-zone { border-color: #3b82f6; }
        .p2-zone { border-color: #ef4444; }
        .p-score { font-size: 4rem; font-weight: 800; margin: 0; }
        .p-label { font-size: 1.2rem; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        .p1-zone .p-label { color: #3b82f6; }
        .p2-zone .p-label { color: #ef4444; }
        .keys-hint { margin-top: 15px; font-size: 0.8rem; color: var(--muted); text-align: center; line-height: 1.8; }
        .key-box { display: inline-block; padding: 2px 8px; border: 1px solid var(--muted); border-radius: 5px; margin: 0 5px; font-family: monospace; font-weight: bold; color: var(--text); background: rgba(255,255,255,0.1); }
        
        .battle-center { width: 100%; text-align: center; margin-top: 20px; border-top: 1px solid #334155; padding-top: 20px; }
        .battle-settings { width: 100%; text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid #334155; }
        .b-word { font-size: 2.2rem; color: var(--text); font-weight: bold; display: block; margin-bottom: 5px; }
        .b-connector { color: var(--muted); font-style: italic; font-size: 0.9rem; margin-bottom: 5px; }
        .b-def { font-size: 1.3rem; color: var(--primary); font-weight: 500; min-height: 30px; }
        .battle-feedback { font-size: 1.5rem; font-weight: 800; margin-top: 10px; height: 30px; }

        /* DUEL CHOICE STYLES */
        .duel-options { display: flex; gap: 20px; width: 100%; margin-top: 30px; }
        .duel-opt { flex: 1; padding: 30px; border: 2px solid #475569; border-radius: 12px; font-size: 1.5rem; font-weight: bold; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.3); text-align: center; }
        .duel-opt.left-opt { border-color: #3b82f6; }
        .duel-opt.right-opt { border-color: #ef4444; }
        .duel-opt.correct { background: var(--success); color: var(--bg); border-color: var(--success); }

        /* TRIPLE THREAT STYLES */
        .triple-options { display: flex; flex-direction: column; gap: 10px; width: 100%; margin-top: 20px; }
        .triple-opt { width: 100%; padding: 15px; border: 1px solid #475569; border-radius: 8px; font-size: 1.2rem; cursor: pointer; background: rgba(0,0,0,0.3); transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .triple-opt.correct { background: var(--success); color: var(--bg); border-color: var(--success); }
        .triple-key { font-family: monospace; font-weight: bold; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; }

        /* SNIPER MODE STYLES */
        .sniper-container { width: 100%; text-align: center; padding: 20px; }
        .sniper-target { font-size: 3rem; color: var(--warning); font-weight: bold; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .sniper-scope { width: 100%; height: 100px; background: #000; border: 4px solid var(--danger); border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 30px; overflow: hidden; box-shadow: 0 0 20px var(--danger); }
        .sniper-scope::before { content: ""; position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: rgba(255,0,0,0.5); }
        .sniper-scope::after { content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(255,0,0,0.5); }
        .sniper-text { font-size: 1.5rem; color: #fff; z-index: 5; font-weight: bold; padding: 0 20px; }

        .table-wrapper { max-height: 500px; overflow-y: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #334155; vertical-align: top; }
        th { position: sticky; top: 0; background: var(--card); color: var(--primary); z-index: 10; }
        .search-bar { width: 95%; padding: 12px; margin-bottom: 5px; border-radius: 8px; border: 1px solid #475569; background: var(--bg); color: var(--text); }
        .speak-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; margin-left: 8px; transition: 0.2s; }
        .speak-btn:hover { transform: scale(1.2); }
        
        .role-badge { display: inline-block; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; margin-left: 10px; vertical-align: middle; }
        .role-p1 { background: var(--p1); color: white; }
        .role-p2 { background: var(--p2); color: white; }
        
        .inactive-zone { opacity: 0.5; filter: grayscale(1); pointer-events: none; }

        @media (max-width: 768px) {
            #main-app { flex-direction: column; }
            .sidebar { width: 100%; height: 100px; flex-direction: row; overflow-x: auto; border-right: none; border-bottom: 1px solid #334155; padding: 10px; align-items: center; }
            .sidebar-header, .nav-category, .user-welcome { display: none; }
            .tab-btn { flex-direction: column; font-size: 0.7rem; text-align: center; padding: 8px; gap: 5px; min-width: 80px; justify-content: center; }
            .main-content { padding: 15px; }
            .content-container { padding: 1.5rem; }
            .battle-arena { flex-direction: column; }
            .player-zone { width: 100%; height: 150px; }
        }
    </style>
</head>
<body>

<audio id="bg-music" loop><source src="backsound.mp3" type="audio/mpeg"></audio>
<audio id="sfx-correct"><source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg"></audio>
<audio id="sfx-wrong"><source src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" type="audio/mpeg"></audio>

<div id="intro-screen">
    <canvas id="particle-canvas"></canvas>
    <div class="intro-content">
        <div class="intro-title">ONLINE BATTLE</div>
        <div class="intro-subtitle">Vocabulary Battle Arena (Multiplayer)</div>
        
        <div class="lobby-box">
            <h3 style="margin:0; color:var(--primary);">MULTIPLAYER LOBBY</h3>
            <input type="text" id="room-code" class="room-input" placeholder="ROOM CODE" maxlength="6">
            <div style="display:flex; gap:10px;">
                <button class="lobby-btn btn-create" style="flex:1" onclick="createRoom()">CREATE ROOM</button>
                <button class="lobby-btn btn-join" style="flex:1" onclick="joinRoom()">JOIN ROOM</button>
            </div>
            <div id="lobby-status" class="lobby-status">Enter a code to create/join</div>
        </div>
    </div>
</div>

<div id="main-app">
    <nav class="sidebar">
        <div class="sidebar-header">MENU</div>
        <div class="user-welcome" id="display-user-name">Welcome <span id="my-role-badge"></span></div>
        
        <button class="tab-btn back-btn" onclick="location.reload()"><span>‚¨Ö</span> <span>Exit Room</span></button>

        <div class="nav-category">Multiplayer Games</div>
        <button class="tab-btn active" id="tab-battle-btn" onclick="openTab(event, 'battle-tab')"><span class="tab-icon">‚öîÔ∏è</span> <span>1 vs 1 Battle</span></button>
        <button class="tab-btn" id="tab-duel-btn" onclick="openTab(event, 'duel-tab')"><span class="tab-icon">ü§úü§õ</span> <span>Duel Choice</span></button>
        <button class="tab-btn" id="tab-sniper-btn" onclick="openTab(event, 'sniper-tab')"><span class="tab-icon">üéØ</span> <span>Sniper Reflex</span></button>
        <button class="tab-btn" id="tab-triple-btn" onclick="openTab(event, 'triple-tab')"><span class="tab-icon">‚ö°</span> <span>Triple Threat</span></button>

        <div class="nav-category">Reference</div>
        <button class="tab-btn" id="tab-list-btn" onclick="openTab(event, 'list-tab')"><span class="tab-icon">üìö</span> <span>Word List</span></button>
    </nav>

    <main class="main-content">
        <div class="content-container">
            <div class="game-controls">
                <div class="left-controls">
                    <div class="music-wrapper"><button class="music-btn" id="music-toggle" onclick="toggleMusic()">üéµ</button><input type="range" id="vol-control" min="0" max="1" step="0.1" value="0.3" oninput="adjustVolume()"></div>
                    <select class="theme-select" onchange="changeTheme(this.value)"><option value="classic">Classic</option><option value="cyberpunk">Cyberpunk</option><option value="matrix">Matrix</option><option value="royal">Royal</option></select>
                </div>
                <div style="color:var(--muted); font-size:0.9rem;">Room: <span id="display-room-code" style="color:var(--primary); font-weight:bold;">---</span></div>
            </div>

            <div id="battle-tab" class="tab-content active">
                <h1>1 VS 1 Battle (True/False)</h1>
                <div class="battle-settings">
                    <span style="color:var(--primary); font-weight:bold; margin-right:10px;">Winning Score:</span>
                    <input type="number" id="battle-target-score" class="settings-input" value="10" min="1" max="100">
                    <button class="action-btn" id="battle-start-btn" style="margin-left:10px; background:var(--warning); color:#000;" onclick="broadcastReset('battle')">Set Rules / Reset</button>
                </div>
                <div class="battle-arena">
                    <div class="player-zone p1-zone" id="b-p1-zone">
                        <div class="p-label">Player 1</div><div class="p-score" id="p1-score">0</div><div class="keys-hint"><span class="key-box">A</span> True <span class="key-box">S</span> False</div>
                    </div>
                    <div class="player-zone p2-zone" id="b-p2-zone">
                        <div class="p-label">Player 2</div><div class="p-score" id="p2-score">0</div><div class="keys-hint"><span class="key-box">K</span> True <span class="key-box">L</span> False</div>
                    </div>
                </div>
                <div class="battle-center"><div class="b-word" id="b-word">WAITING...</div><div class="b-connector">means</div><div class="b-def" id="b-def">For Host</div><div class="battle-feedback" id="battle-msg"></div></div>
            </div>

            <div id="duel-tab" class="tab-content">
                <h1>Duel Choice</h1>
                <div class="battle-settings">
                    <span style="color:var(--primary); font-weight:bold; margin-right:10px;">Winning Score:</span>
                    <input type="number" id="duel-target-score" class="settings-input" value="10" min="1" max="100">
                    <button class="action-btn" id="duel-start-btn" style="margin-left:10px; background:var(--warning); color:#000;" onclick="broadcastReset('duel')">Set Rules / Start</button>
                </div>
                <div class="battle-center">
                    <div class="b-def" id="duel-def" style="min-height:50px; font-size:1.6rem; margin-bottom:20px;">Press Start</div>
                    <div class="duel-options">
                        <div class="duel-opt left-opt" id="duel-opt-1">Word A</div>
                        <div class="duel-opt right-opt" id="duel-opt-2">Word B</div>
                    </div>
                    <div class="battle-feedback" id="duel-msg"></div>
                </div>
                <div class="battle-arena" style="margin-top:30px;">
                    <div class="player-zone p1-zone" id="d-p1-zone" style="height:120px;">
                        <div class="p-label">P1 (Score: <span id="d1-score">0</span>)</div>
                        <div class="keys-hint"><span class="key-box">A</span> Left <span class="key-box">D</span> Right</div>
                    </div>
                    <div class="player-zone p2-zone" id="d-p2-zone" style="height:120px;">
                        <div class="p-label">P2 (Score: <span id="d2-score">0</span>)</div>
                        <div class="keys-hint"><span class="key-box">J</span> Left <span class="key-box">L</span> Right</div>
                    </div>
                </div>
            </div>

            <div id="sniper-tab" class="tab-content">
                <h1>Sniper Reflex</h1>
                <p style="text-align:center; color:var(--muted); margin-bottom:20px;">Wait for the correct meaning, then SHOOT!</p>
                <div class="battle-settings">
                    <span style="color:var(--primary); font-weight:bold; margin-right:10px;">Winning Score:</span>
                    <input type="number" id="sniper-target-score" class="settings-input" value="10" min="1" max="100">
                    <button class="action-btn" id="sniper-start-btn" style="margin-left:10px; background:var(--warning); color:#000;" onclick="broadcastReset('sniper')">Set Rules / Start</button>
                </div>
                
                <div class="sniper-container">
                    <div class="sniper-target" id="sniper-target">TARGET</div>
                    <div class="sniper-scope">
                        <div class="sniper-text" id="sniper-text">...</div>
                    </div>
                    <div class="battle-feedback" id="sniper-msg"></div>
                </div>

                <div class="battle-arena">
                    <div class="player-zone p1-zone" id="s-p1-zone" style="height:120px;">
                        <div class="p-label">P1 (Score: <span id="s1-score">0</span>)</div>
                        <div class="keys-hint"><span class="key-box">S</span> SHOOT</div>
                    </div>
                    <div class="player-zone p2-zone" id="s-p2-zone" style="height:120px;">
                        <div class="p-label">P2 (Score: <span id="s2-score">0</span>)</div>
                        <div class="keys-hint"><span class="key-box">K</span> SHOOT</div>
                    </div>
                </div>
            </div>

            <div id="triple-tab" class="tab-content">
                <h1>Triple Threat</h1>
                <div class="battle-settings">
                    <span style="color:var(--primary); font-weight:bold; margin-right:10px;">Winning Score:</span>
                    <input type="number" id="triple-target-score" class="settings-input" value="10" min="1" max="100">
                    <button class="action-btn" id="triple-start-btn" style="margin-left:10px; background:var(--warning); color:#000;" onclick="broadcastReset('triple')">Set Rules / Start</button>
                </div>
                <div class="battle-center">
                    <div class="b-word" id="triple-word" style="font-size:2.5rem; margin-bottom:20px;">READY?</div>
                    <div class="triple-options">
                        <div class="triple-opt" id="triple-opt-1"><span class="triple-key">A / J</span> <span id="t-text-1">Option 1</span></div>
                        <div class="triple-opt" id="triple-opt-2"><span class="triple-key">S / K</span> <span id="t-text-2">Option 2</span></div>
                        <div class="triple-opt" id="triple-opt-3"><span class="triple-key">D / L</span> <span id="t-text-3">Option 3</span></div>
                    </div>
                    <div class="battle-feedback" id="triple-msg"></div>
                </div>
                <div class="battle-arena" style="margin-top:20px;">
                    <div class="player-zone p1-zone" id="t-p1-zone" style="height:100px;">
                        <div class="p-label">P1 (Score: <span id="t1-score">0</span>)</div>
                    </div>
                    <div class="player-zone p2-zone" id="t-p2-zone" style="height:100px;">
                        <div class="p-label">P2 (Score: <span id="t2-score">0</span>)</div>
                    </div>
                </div>
            </div>

            <div id="list-tab" class="tab-content"><h1>Vocabulary List</h1><input type="text" class="search-bar" id="search" onkeyup="filterTable()" placeholder="Cari kata..."><div class="table-wrapper"><table><thead><tr><th style="width:25%;">English</th><th style="width:35%;">Meaning</th><th style="width:40%;">Example</th></tr></thead><tbody id="table-body"></tbody></table></div></div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, push } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";
    import { fullVocab } from './intermediate game.js'; // Ensure this file exists

   const firebaseConfig = {
  apiKey: "AIzaSyAgYCaaoGMzZWVT2dRov7ALUnnMhHoqXmE",
  authDomain: "english-check-db.firebaseapp.com",
  databaseURL: "https://english-check-db-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "english-check-db",
  storageBucket: "english-check-db.firebasestorage.app",
  messagingSenderId: "136352630898",
  appId: "1:136352630898:web:dcaa103fa848ca38de9aeb"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- GLOBAL VARIABLES ---
    let myRole = null; // 1 or 2
    let currentRoom = null;
    let gameData = [...fullVocab];
    
    // --- LOBBY FUNCTIONS ---
    window.createRoom = function() {
        const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
        const roomRef = ref(db, 'matches/' + roomCode);
        
        set(roomRef, {
            status: 'waiting',
            p1: 'connected',
            p2: 'waiting',
            activeGame: 'battle',
            scores: { p1: 0, p2: 0 },
            currentRound: {
                timestamp: Date.now(),
                word: "Waiting for P2...",
                def: "Share Code: " + roomCode,
                answer: null, // For Battle/Duel logic
                options: null // For Triple logic
            },
            input: { key: '', player: 0, timestamp: 0 } // For key mirroring
        }).then(() => {
            enterGame(roomCode, 1);
        });
    }

    window.joinRoom = function() {
        const code = document.getElementById('room-code').value;
        if(code.length !== 4) { alert("Code must be 4 digits"); return; }
        
        const roomRef = ref(db, 'matches/' + code);
        onValue(roomRef, (snapshot) => {
            if(snapshot.exists()) {
                update(roomRef, { p2: 'connected', status: 'ready' });
                enterGame(code, 2);
            } else {
                alert("Room not found!");
            }
        }, { onlyOnce: true });
    }

    function enterGame(roomCode, role) {
        currentRoom = roomCode;
        myRole = role;
        
        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('display-room-code').innerText = roomCode;
        
        const badge = document.getElementById('my-role-badge');
        badge.innerText = role === 1 ? "PLAYER 1 (HOST)" : "PLAYER 2";
        badge.className = role === 1 ? "role-badge role-p1" : "role-badge role-p2";

        setupFirebaseListeners();
        setupUIForRole();
    }

    function setupUIForRole() {
        // Disable start buttons for Player 2
        if (myRole === 2) {
            document.getElementById('battle-start-btn').style.display = 'none';
            document.getElementById('duel-start-btn').style.display = 'none';
            document.getElementById('sniper-start-btn').style.display = 'none';
            document.getElementById('triple-start-btn').style.display = 'none';
            
            // Visual cue for disabled zones
            document.querySelectorAll('.p1-zone').forEach(el => el.classList.add('inactive-zone'));
        } else {
             document.querySelectorAll('.p2-zone').forEach(el => el.classList.add('inactive-zone'));
        }
    }

    // --- FIREBASE LISTENERS (THE BRAIN) ---
    function setupFirebaseListeners() {
        const roomRef = ref(db, 'matches/' + currentRoom);
        
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            // Update Input (Key Mirroring)
            if (data.input && data.input.timestamp > lastProcessedInput) {
                lastProcessedInput = data.input.timestamp;
                processRemoteInput(data.input.player, data.input.key);
            }

            // Sync Game State (Round Data)
            if (myRole === 2 && data.currentRound) {
                // If I am P2, I just display what P1 generated
                syncDisplay(data.activeGame, data.currentRound);
            }
            
            // Sync Scores
            updateScoresUI(data.scores);
        });
    }

    let lastProcessedInput = 0;

    // --- GAME CONTROL (HOST ONLY) ---
    window.broadcastReset = function(gameMode) {
        if(myRole !== 1) return;
        
        // Reset Scores in DB
        update(ref(db, 'matches/' + currentRoom), {
            activeGame: gameMode,
            scores: { p1: 0, p2: 0 },
            status: 'playing'
        });
        
        // Trigger first round
        if(gameMode === 'battle') startBattleRoundHost();
        if(gameMode === 'duel') startDuelRoundHost();
        if(gameMode === 'sniper') startSniperRoundHost();
        if(gameMode === 'triple') startTripleRoundHost();
    }

    // --- BATTLE LOGIC (HOST) ---
    let currentBattleAns = false;
    function startBattleRoundHost() {
        const idx = Math.floor(Math.random() * gameData.length);
        const correctItem = gameData[idx];
        const isCorrect = Math.random() < 0.5;
        currentBattleAns = isCorrect;
        
        let displayDef = isCorrect ? correctItem.idn : getRandomWrongDef(correctItem.eng);
        
        update(ref(db, 'matches/' + currentRoom + '/currentRound'), {
            word: correctItem.eng,
            def: displayDef,
            answer: isCorrect,
            timestamp: Date.now()
        });
        
        // Also update local display immediately
        syncDisplay('battle', { word: correctItem.eng, def: displayDef });
    }

    // --- DUEL LOGIC (HOST) ---
    let currentDuelAns = 0; // 1 or 2
    function startDuelRoundHost() {
        const idx = Math.floor(Math.random() * gameData.length);
        const correctItem = gameData[idx];
        const distractor = getRandomWrongItem(correctItem.eng);
        const correctPos = Math.random() < 0.5 ? 1 : 2;
        currentDuelAns = correctPos;

        update(ref(db, 'matches/' + currentRoom + '/currentRound'), {
            def: correctItem.idn,
            options: [
                correctPos === 1 ? correctItem.eng : distractor.eng,
                correctPos === 1 ? distractor.eng : correctItem.eng
            ],
            answer: correctPos,
            timestamp: Date.now()
        });
        syncDisplay('duel', { def: correctItem.idn, options: [correctPos === 1 ? correctItem.eng : distractor.eng, correctPos === 1 ? distractor.eng : correctItem.eng] });
    }

    // --- SNIPER LOGIC (HOST) ---
    // Sniper is tricky online due to lag. Simplified: Host updates text every 1s.
    let sniperInterval;
    function startSniperRoundHost() {
        clearInterval(sniperInterval);
        const idx = Math.floor(Math.random() * gameData.length);
        const target = gameData[idx];
        
        update(ref(db, 'matches/' + currentRoom + '/currentRound'), {
            word: target.eng, // Target
            def: "...",
            answer: target.idn, // Store actual answer string for verify
            timestamp: Date.now()
        });
        syncDisplay('sniper', { word: target.eng, def: "..." });

        let count = 0;
        sniperInterval = setInterval(() => {
            count++;
            let showCorrect = Math.random() < 0.25 || count > 6;
            let showDef = showCorrect ? target.idn : getRandomWrongDef(target.eng);
            
            update(ref(db, 'matches/' + currentRoom + '/currentRound/def'), showDef);
            syncDisplay('sniper', { word: target.eng, def: showDef }); // Local update
            
            if(showCorrect) { clearInterval(sniperInterval); setTimeout(() => { if(myRole===1) startSniperRoundHost(); }, 3000); } // Auto reset if missed
        }, 1200);
    }

    // --- TRIPLE LOGIC (HOST) ---
    let currentTripleAns = 0;
    function startTripleRoundHost() {
        const idx = Math.floor(Math.random() * gameData.length);
        const correctItem = gameData[idx];
        let opts = [correctItem];
        while(opts.length < 3) {
            let d = getRandomWrongItem(correctItem.eng);
            if(!opts.find(x => x.eng === d.eng)) opts.push(d);
        }
        // Simple shuffle
        opts.sort(() => Math.random() - 0.5);
        currentTripleAns = opts.indexOf(correctItem) + 1;

        update(ref(db, 'matches/' + currentRoom + '/currentRound'), {
            word: correctItem.eng,
            options: opts.map(o => o.idn),
            answer: currentTripleAns,
            timestamp: Date.now()
        });
        syncDisplay('triple', { word: correctItem.eng, options: opts.map(o => o.idn) });
    }


    // --- DISPLAY SYNC (P2 & P1 Local) ---
    function syncDisplay(mode, data) {
        if (mode === 'battle') {
            document.getElementById('b-word').innerText = data.word;
            document.getElementById('b-def').innerText = data.def;
            document.getElementById('battle-msg').innerText = "GO!";
            document.getElementById('battle-msg').style.color = "var(--text)";
        }
        else if (mode === 'duel') {
            document.getElementById('duel-def').innerText = data.def;
            document.getElementById('duel-opt-1').innerText = data.options[0];
            document.getElementById('duel-opt-2').innerText = data.options[1];
            document.getElementById('duel-opt-1').className = "duel-opt left-opt"; // reset colors
            document.getElementById('duel-opt-2').className = "duel-opt right-opt";
            document.getElementById('duel-msg').innerText = "Choose!";
        }
        else if (mode === 'sniper') {
            document.getElementById('sniper-target').innerText = data.word;
            document.getElementById('sniper-text').innerText = data.def;
        }
        else if (mode === 'triple') {
            document.getElementById('triple-word').innerText = data.word;
            document.getElementById('t-text-1').innerText = data.options[0];
            document.getElementById('t-text-2').innerText = data.options[1];
            document.getElementById('t-text-3').innerText = data.options[2];
            document.getElementById('triple-opt-1').classList.remove('correct');
            document.getElementById('triple-opt-2').classList.remove('correct');
            document.getElementById('triple-opt-3').classList.remove('correct');
            document.getElementById('triple-msg').innerText = "Choose!";
        }
    }

    function updateScoresUI(scores) {
        if(!scores) return;
        document.getElementById('p1-score').innerText = scores.p1;
        document.getElementById('p2-score').innerText = scores.p2;
        document.getElementById('d1-score').innerText = scores.p1;
        document.getElementById('d2-score').innerText = scores.p2;
        document.getElementById('s1-score').innerText = scores.p1;
        document.getElementById('s2-score').innerText = scores.p2;
        document.getElementById('t1-score').innerText = scores.p1;
        document.getElementById('t2-score').innerText = scores.p2;
    }

    // --- INPUT HANDLING ---
    // 1. Capture Local Key -> Send to Firebase
    document.addEventListener('keydown', (e) => {
        if (!currentRoom) return;
        const key = e.key.toLowerCase();
        
        // P1 allowed keys
        if (myRole === 1 && ['a','s','d','w'].includes(key)) {
            sendInput(key);
        }
        // P2 allowed keys
        if (myRole === 2 && ['j','k','l','i'].includes(key)) {
            sendInput(key);
        }
    });

    function sendInput(k) {
        update(ref(db, 'matches/' + currentRoom + '/input'), {
            player: myRole,
            key: k,
            timestamp: Date.now()
        });
    }

    // 2. Process Remote Input (The Logic Hub)
    // Only Host (P1) calculates validity to avoid conflicts, then updates score
    function processRemoteInput(player, key) {
        // Visual Feedback (Flash Zone)
        flashZone(player);

        if (myRole !== 1) return; // Only Host calculates scores

        get(ref(db, 'matches/' + currentRoom)).then((snapshot) => {
            const data = snapshot.val();
            const mode = data.activeGame;
            const round = data.currentRound;
            const scores = data.scores || { p1: 0, p2: 0 };
            let win = false;

            if (mode === 'battle') {
                // P1: A(True), S(False). P2: K(True), L(False)
                let choice = null;
                if (player === 1) choice = (key === 'a');
                if (player === 1 && key === 's') choice = false;
                if (player === 2) choice = (key === 'k');
                if (player === 2 && key === 'l') choice = false;
                
                if (choice === round.answer) win = true;
            }
            else if (mode === 'duel') {
                // P1: A(1), D(2). P2: J(1), L(2)
                let choice = 0;
                if (player === 1) choice = (key === 'a') ? 1 : 2;
                if (player === 2) choice = (key === 'j') ? 1 : 2;
                
                if (choice === round.answer) win = true;
            }
            else if (mode === 'sniper') {
                // Any shot checks against current def
                if (round.word === round.answer && round.def === round.answer) {
                    // This logic is flawed due to async, simplified: check if def == correct def
                    // Actually for sniper, we passed 'answer' as the correct string
                    // We need to check if displayed def equals answer
                    if (document.getElementById('sniper-text').innerText === round.answer) win = true;
                }
            }
            else if (mode === 'triple') {
                let choice = 0;
                if (player === 1) { if(key=='a') choice=1; if(key=='s') choice=2; if(key=='d') choice=3; }
                if (player === 2) { if(key=='j') choice=1; if(key=='k') choice=2; if(key=='l') choice=3; }
                if (choice === round.answer) win = true;
            }

            // Update Score
            if (win) {
                if (player === 1) scores.p1++; else scores.p2++;
                update(ref(db, 'matches/' + currentRoom + '/scores'), scores);
                // Next Round
                setTimeout(() => {
                    if(mode==='battle') startBattleRoundHost();
                    if(mode==='duel') startDuelRoundHost();
                    if(mode==='triple') startTripleRoundHost();
                }, 1000);
            } else {
                // Wrong answer penalty? For now, point to opponent
                if (player === 1) scores.p2++; else scores.p1++;
                update(ref(db, 'matches/' + currentRoom + '/scores'), scores);
                setTimeout(() => {
                    if(mode==='battle') startBattleRoundHost();
                    if(mode==='duel') startDuelRoundHost();
                    if(mode==='triple') startTripleRoundHost();
                }, 1000);
            }
        });
    }

    // --- UTILS ---
    function getRandomWrongDef(correctEng) {
        let item = gameData[Math.floor(Math.random() * gameData.length)];
        while(item.eng === correctEng) item = gameData[Math.floor(Math.random() * gameData.length)];
        return item.idn;
    }
    function getRandomWrongItem(correctEng) {
        let item = gameData[Math.floor(Math.random() * gameData.length)];
        while(item.eng === correctEng) item = gameData[Math.floor(Math.random() * gameData.length)];
        return item;
    }
    function get(r) { // wrapper for get to keep code clean
        return import("https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js").then(m => m.get(r));
    }
    function flashZone(player) {
        const prefix = document.querySelector('.tab-content.active').id.split('-')[0].charAt(0); // b, d, s, t
        const zone = document.getElementById(prefix + '-p' + player + '-zone');
        if(zone) {
            zone.style.background = "rgba(255,255,255,0.4)";
            setTimeout(() => zone.style.background = "rgba(0,0,0,0.2)", 200);
        }
    }

    // Tab Switching
    window.openTab = function(evt, tabName) {
        const contents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < contents.length; i++) contents[i].style.display = "none";
        const buttons = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < buttons.length; i++) buttons[i].className = buttons[i].className.replace(" active", "");
        document.getElementById(tabName).style.display = "block";
        if(evt) evt.currentTarget.className += " active";
        
        // Notify reset if Host switches tab? Maybe complex. For now just switch UI.
    }
    
    // Initial particle & Table setup (keep existing)
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let particlesArray = [];
    class Particle {
        constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 3 + 1; this.speedX = Math.random() * 1 - 0.5; this.speedY = Math.random() * 1 - 0.5; this.color = '#38bdf8'; }
        update() { this.x += this.speedX; this.y += this.speedY; if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX; if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY; }
        draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
    }
    function initParticles() { for (let i = 0; i < 50; i++) particlesArray.push(new Particle()); }
    function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update(); particlesArray[i].draw();
        }
        requestAnimationFrame(animateParticles);
    }
    initParticles(); animateParticles();

    // Fill table
    function buildTable() { 
        const tbody = document.getElementById('table-body'); 
        tbody.innerHTML = gameData.map(v => `<tr><td style="font-weight:bold; color:var(--primary)">${v.eng}</td><td>${v.idn}</td><td>"${v.ex}"</td></tr>`).join(''); 
    }
    buildTable();
    
    // Filter
    window.filterTable = function() {
        let input = document.getElementById("search").value.toLowerCase();
        let rows = document.getElementById("table-body").getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
            let text = rows[i].textContent.toLowerCase();
            rows[i].style.display = text.includes(input) ? "" : "none";
        }
    }
</script>
<script src="intermediate game.js"></script>
</body>
</html>