<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTIPLAYER INTERMEDIATE (ONLINE FIXED)</title>
    <style>
        /* CSS VARIABLES & RESET */
        :root { --bg: #0f172a; --card: #1e293b; --sidebar: #111827; --primary: #38bdf8; --text: #f8fafc; --muted: #94a3b8; --danger: #f87171; --success: #4ade80; --warning: #fbbf24; --p1: #3b82f6; --p2: #ef4444; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; transition: background-color 0.3s; }
        
        /* INTRO SCREEN & LOBBY */
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; transition: opacity 0.5s ease-out; }
        .intro-content { z-index: 10; text-align: center; position: relative; width: 100%; max-width: 800px; padding: 20px; }
        .intro-title { font-size: 3rem; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; font-weight: 800; letter-spacing: 2px; }
        
        /* LOBBY BOX */
        .lobby-box { background: rgba(30, 41, 59, 0.95); padding: 30px; border-radius: 20px; border: 1px solid var(--primary); display: flex; flex-direction: column; gap: 15px; width: 350px; margin: 0 auto; box-shadow: 0 0 30px rgba(56, 189, 248, 0.2); }
        .room-input { padding: 15px; border-radius: 10px; border: 2px solid #475569; background: #0f172a; color: white; font-size: 1.2rem; text-align: center; letter-spacing: 3px; text-transform: uppercase; font-weight: bold; width: 100%; }
        .lobby-btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; width: 100%; }
        .btn-create { background: var(--primary); color: #0f172a; margin-bottom: 10px; }
        .btn-join { background: var(--success); color: #0f172a; }
        .btn-create:hover, .btn-join:hover { transform: scale(1.02); filter: brightness(1.1); }
        .lobby-status { margin-top: 10px; color: var(--warning); font-size: 0.9rem; min-height: 20px; text-align: center; }

        /* MAIN APP LAYOUT */
        #main-app { display: none; width: 100%; height: 100vh; flex-direction: row; }
        .sidebar { width: 250px; background: var(--sidebar); border-right: 1px solid #334155; display: flex; flex-direction: column; padding: 20px 10px; gap: 5px; flex-shrink: 0; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; background: var(--bg); }
        .content-container { background: var(--card); padding: 2rem; border-radius: 20px; width: 100%; max-width: 900px; border: 1px solid #334155; position: relative; }

        /* UI ELEMENTS */
        .tab-btn { background: transparent; color: var(--text); border: none; padding: 12px 15px; cursor: pointer; border-radius: 8px; font-size: 0.95rem; text-align: left; display: flex; align-items: center; gap: 10px; width: 100%; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: var(--primary); color: #0f172a; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* GAME ZONES */
        .battle-arena { display: flex; gap: 10px; margin-top: 20px; }
        .player-zone { flex: 1; height: 200px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 3px solid #333; background: rgba(0,0,0,0.2); transition: 0.2s; }
        .p1-zone { border-color: var(--p1); } .p2-zone { border-color: var(--p2); }
        .p-score { font-size: 3rem; font-weight: 800; }
        .battle-center { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .b-word { font-size: 2rem; font-weight: bold; }
        .b-def { font-size: 1.2rem; color: var(--primary); margin: 10px 0; min-height: 40px; }
        .msg-box { font-size: 1.2rem; font-weight: bold; height: 30px; margin-top: 10px; }
        
        /* CONTROLS */
        .action-btn { background: var(--warning); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .role-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .role-p1 { background: var(--p1); color: white; } .role-p2 { background: var(--p2); color: white; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            #main-app { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; }
            .battle-arena { flex-direction: column; }
        }
    </style>
</head>
<body>

<audio id="bg-music" loop><source src="backsound.mp3" type="audio/mpeg"></audio>

<div id="intro-screen">
    <div class="intro-content">
        <div class="intro-title">ENGLISH BATTLE</div>
        <div class="lobby-box">
            <h3 style="margin:0; text-align:center; color:white;">MULTIPLAYER LOBBY</h3>
            <input type="text" id="room-code" class="room-input" placeholder="CODE" maxlength="4">
            <button class="lobby-btn btn-create" id="btn-create" onclick="window.createRoom()">CREATE NEW ROOM (HOST)</button>
            <button class="lobby-btn btn-join" id="btn-join" onclick="window.joinRoom()">JOIN ROOM (PLAYER)</button>
            <div id="lobby-status" class="lobby-status">Ready to connect...</div>
        </div>
    </div>
</div>

<div id="main-app">
    <nav class="sidebar">
        <div style="color:var(--primary); font-weight:bold; padding:10px;">MENU</div>
        <div style="padding:0 10px 20px 10px; font-size:0.9rem;">Role: <span id="my-role-badge">---</span></div>
        <button class="tab-btn active" onclick="switchTab('battle')">⚔️ Battle Mode</button>
        <button class="tab-btn" onclick="location.reload()" style="margin-top:auto; color:var(--danger);">⬅ Exit Room</button>
    </nav>

    <main class="main-content">
        <div class="content-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <span>Room Code: <strong id="display-room-code" style="color:var(--primary); font-size:1.2rem;">---</strong></span>
                <button class="action-btn" id="start-btn" onclick="window.broadcastStart()" style="display:none;">START / NEXT ROUND</button>
            </div>

            <div id="tab-battle" class="tab-content active">
                <div class="battle-arena">
                    <div class="player-zone p1-zone" id="zone-p1">
                        <div>PLAYER 1</div>
                        <div class="p-score" id="score-p1">0</div>
                        <div style="font-size:0.8rem; opacity:0.7;">Key: A (True) / S (False)</div>
                    </div>
                    <div class="player-zone p2-zone" id="zone-p2">
                        <div>PLAYER 2</div>
                        <div class="p-score" id="score-p2">0</div>
                        <div style="font-size:0.8rem; opacity:0.7;">Key: K (True) / L (False)</div>
                    </div>
                </div>
                <div class="battle-center">
                    <div class="b-word" id="game-word">WAITING...</div>
                    <div style="font-style:italic; color:#666;">means</div>
                    <div class="b-def" id="game-def">Waiting for Host to Start</div>
                    <div class="msg-box" id="game-msg"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // 1. CONFIGURATION
   const firebaseConfig = {
  apiKey: "AIzaSyAgYCaaoGMzZWVT2dRov7ALUnnMhHoqXmE",
  authDomain: "english-check-db.firebaseapp.com",
  databaseURL: "https://english-check-db-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "english-check-db",
  storageBucket: "english-check-db.firebasestorage.app",
  messagingSenderId: "136352630898",
  appId: "1:136352630898:web:dcaa103fa848ca38de9aeb"
};

    // 2. INITIALIZE FIREBASE
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 3. VOCABULARY LIST (Embedded to prevent loading errors)
    const fullVocab = [
        { eng: "Resilience", idn: "Ketangguhan", ex: "She showed resilience." },
        { eng: "Ephemeral", idn: "Sesaat / Fana", ex: "Life is ephemeral." },
        { eng: "Serendipity", idn: "Kebetulan yang indah", ex: "It was serendipity." },
        { eng: "Eloquent", idn: "Fasih / Pandai bicara", ex: "He is an eloquent speaker." },
        { eng: "Inevitable", idn: "Tak terelakkan", ex: "Change is inevitable." },
        { eng: "Meticulous", idn: "Sangat teliti", ex: "He is meticulous." },
        { eng: "Obsolete", idn: "Usang / Tidak dipakai lagi", ex: "Typewriters are obsolete." },
        { eng: "Ponder", idn: "Merenungkan", ex: "Ponder the future." },
        { eng: "Candid", idn: "Jujur / Terus terang", ex: "A candid answer." },
        { eng: "Ambiguous", idn: "Bermakna ganda / Tidak jelas", ex: "The rules are ambiguous." }
    ];

    // 4. GLOBAL VARIABLES
    let myRole = 0; // 1 = Host, 2 = Joiner
    let currentRoom = "";
    let lastKeyTimestamp = 0;

    // 5. ATTACH FUNCTIONS TO WINDOW (Crucial for HTML buttons to work)
    
    // --- CREATE ROOM ---
    window.createRoom = function() {
        const btn = document.getElementById('btn-create');
        const status = document.getElementById('lobby-status');
        
        btn.disabled = true;
        btn.innerText = "Creating...";
        status.innerText = "Connecting to server...";

        const code = Math.floor(1000 + Math.random() * 9000).toString(); // Generate 4 digit code
        
        // Write to Firebase
        set(ref(db, 'matches/' + code), {
            host: 'online',
            status: 'waiting',
            scores: { p1: 0, p2: 0 },
            round: { word: "Ready", def: "Press Start", answer: null, timestamp: 0 },
            input: { player: 0, key: '', timestamp: 0 }
        })
        .then(() => {
            enterGame(code, 1);
        })
        .catch((error) => {
            console.error(error);
            alert("Error creating room: " + error.message);
            btn.disabled = false;
            btn.innerText = "CREATE NEW ROOM (HOST)";
            status.innerText = "Connection Failed. Check Console.";
        });
    };

    // --- JOIN ROOM ---
    window.joinRoom = function() {
        const input = document.getElementById('room-code');
        const btn = document.getElementById('btn-join');
        const code = input.value.trim();

        if (code.length !== 4) { alert("Masukkan 4 digit kode!"); return; }

        btn.disabled = true;
        btn.innerText = "Joining...";

        const roomRef = ref(db, 'matches/' + code);
        get(roomRef).then((snapshot) => {
            if (snapshot.exists()) {
                // Update room status to connected
                update(roomRef, { status: 'connected' });
                enterGame(code, 2);
            } else {
                alert("Room tidak ditemukan!");
                btn.disabled = false;
                btn.innerText = "JOIN ROOM (PLAYER)";
            }
        }).catch((error) => {
            alert("Error: " + error.message);
            btn.disabled = false;
            btn.innerText = "JOIN ROOM (PLAYER)";
        });
    };

    // --- GAME START (HOST ONLY) ---
    window.broadcastStart = function() {
        if (myRole !== 1) return;

        // Pick random word
        const item = fullVocab[Math.floor(Math.random() * fullVocab.length)];
        const isTrue = Math.random() < 0.5;
        
        let showDef = item.idn;
        if (!isTrue) {
            // Pick wrong definition
            let wrongItem = fullVocab[Math.floor(Math.random() * fullVocab.length)];
            while(wrongItem.eng === item.eng) wrongItem = fullVocab[Math.floor(Math.random() * fullVocab.length)];
            showDef = wrongItem.idn;
        }

        // Send to Firebase
        update(ref(db, 'matches/' + currentRoom + '/round'), {
            word: item.eng,
            def: showDef,
            answer: isTrue, // Boolean
            timestamp: Date.now()
        });
        
        // Reset msg
        update(ref(db, 'matches/' + currentRoom), { msg: "" });
    };

    // --- ENTER GAME UI ---
    function enterGame(code, role) {
        currentRoom = code;
        myRole = role;

        document.getElementById('intro-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('display-room-code').innerText = code;
        
        const badge = document.getElementById('my-role-badge');
        badge.innerText = role === 1 ? "PLAYER 1 (HOST)" : "PLAYER 2";
        badge.className = role === 1 ? "role-badge role-p1" : "role-badge role-p2";

        if (role === 1) {
            document.getElementById('start-btn').style.display = 'block';
        }

        listenToRoom();
    }

    // --- LISTENER (THE BRAIN) ---
    function listenToRoom() {
        const roomRef = ref(db, 'matches/' + currentRoom);
        
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // Update Scores
            if (data.scores) {
                document.getElementById('score-p1').innerText = data.scores.p1;
                document.getElementById('score-p2').innerText = data.scores.p2;
            }

            // Update Round Question
            if (data.round) {
                document.getElementById('game-word').innerText = data.round.word;
                document.getElementById('game-def').innerText = data.round.def;
            }

            // Update Message (Win/Loss)
            if (data.msg) {
                const msgBox = document.getElementById('game-msg');
                msgBox.innerText = data.msg;
                if(data.msg.includes("Wins")) msgBox.style.color = "var(--success)";
                else msgBox.style.color = "var(--text)";
            }

            // Handle Input Processing (HOST Logic)
            if (myRole === 1 && data.input && data.input.timestamp > lastKeyTimestamp) {
                lastKeyTimestamp = data.input.timestamp;
                processInput(data.input.player, data.input.key, data.round.answer, data.scores);
            }
        });
    }

    // --- PROCESS INPUT (HOST ONLY) ---
    function processInput(playerWhoPressed, key, correctAnswer, currentScores) {
        // Logic: P1 uses A(True)/S(False), P2 uses K(True)/L(False)
        let playerChoice = null;

        if (playerWhoPressed === 1) {
            if (key === 'a') playerChoice = true;
            if (key === 's') playerChoice = false;
        } else if (playerWhoPressed === 2) {
            if (key === 'k') playerChoice = true;
            if (key === 'l') playerChoice = false;
        }

        if (playerChoice === null) return; // Invalid key

        let msg = "";
        let p1 = currentScores.p1;
        let p2 = currentScores.p2;

        if (playerChoice === correctAnswer) {
            // Correct
            msg = `Player ${playerWhoPressed} Wins the Point!`;
            if (playerWhoPressed === 1) p1++; else p2++;
        } else {
            // Wrong
            msg = `Player ${playerWhoPressed} Wrong! Opponent gets Point!`;
            if (playerWhoPressed === 1) p2++; else p1++;
        }

        // Update DB
        update(ref(db, 'matches/' + currentRoom), {
            scores: { p1: p1, p2: p2 },
            msg: msg,
            input: { player: 0, key: '', timestamp: Date.now() } // Reset input
        });

        // Auto next round after delay
        setTimeout(() => {
            window.broadcastStart();
        }, 1500);
    }

    // --- KEYBOARD LISTENER ---
    document.addEventListener('keydown', (e) => {
        if (!currentRoom) return;
        const key = e.key.toLowerCase();
        
        // P1 Keys
        if (myRole === 1 && (key === 'a' || key === 's')) {
            sendKey(1, key);
        }
        // P2 Keys
        if (myRole === 2 && (key === 'k' || key === 'l')) {
            sendKey(2, key);
        }
    });

    function sendKey(role, key) {
        // Just send to DB, let Host process it
        update(ref(db, 'matches/' + currentRoom + '/input'), {
            player: role,
            key: key,
            timestamp: Date.now()
        });
    }

    // Tab Switcher (Visual Only)
    window.switchTab = function(tab) {
        // Currently only Battle mode is active in this fixed version
    }
</script>

</body>
</html>